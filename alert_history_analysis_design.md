# 🎯 アラート履歴分析システム設計書

## 概要
TRADING OPPORTUNITY DETECTEDのアラート履歴を保存し、後からどのタイミングでどのような内容で検知していたのかを確認できるシステムの設計書です。選択したトークンのチャート上にアラートポイントを描画し、それがどれくらい効果のあるアラートだったのかを振り返れる機能を実装します。

## 🎯 アラート履歴分析システムの詳しい説明

### 現在の状況
- アラートはメモリ上にのみ保存（アプリを停止すると消える）
- アラートが出た後の価格変動は追跡していない
- そのアラートが実際に利益につながったかわからない

### 実装したい機能

### 1. **📊 アラート履歴の永続化**
```
データベースに保存する情報：
┌─────────────────────────────────────┐
│ ⏰ 2025-06-09 14:30:15             │
│ 🪙 HYPE                            │
│ 💰 現在価格: $25.50                │
│ 🎪 推奨レバレッジ: 15.2x            │
│ 🎯 信頼度: 82.1%                   │
│ 📊 戦略: Conservative_ML            │
│ ⏱️ 時間足: 1h                      │
└─────────────────────────────────────┘
```

### 2. **📈 価格追跡システム**
アラートが出た後の価格変動を自動記録：
```
HYPE アラート後の価格変動
┌──────────────────────────────────┐
│ 🚨 アラート時: $25.50 (14:30)    │
│ ⏰ 1時間後: $26.80 (+5.1%)       │
│ ⏰ 3時間後: $29.40 (+15.3%)      │
│ ⏰ 1日後: $23.20 (-9.0%)         │
│ ⏰ 3日後: $31.85 (+24.9%)        │
└──────────────────────────────────┘
```

### 3. **🖥️ チャート分析ページ**
新しいWebページを作成：

**URL**: `http://localhost:5001/analysis`

**画面イメージ**:
```
┌─ トークン選択 ─┐ ┌─ 期間選択 ─┐
│ HYPE ▼       │ │ 過去30日 ▼ │
└──────────────┘ └───────────┘

📈 HYPEチャート（過去30日）
┌─────────────────────────────────────┐
│    $30 ┤                            │
│        │     🎯←アラート(+15.3%)     │
│    $25 ┤  📈╱                       │
│        │   ╱   🎯←アラート(-5.2%)    │
│    $20 ┤ ╱                          │
│        └─────────────────────────────│
│      6/1  6/5  6/9  6/13  6/17     │
└─────────────────────────────────────┘

📊 アラート成果
├── ✅ 成功アラート: 8回 (73%)
├── ❌ 失敗アラート: 3回 (27%)
├── 📈 平均リターン: +12.5%
└── 🏆 最高成果: +24.9%
```

### 4. **🎯 各アラートの詳細情報**
チャート上のアラートポイントをクリックすると：
```
┌─────────────────────────────────────┐
│ 🎯 アラート詳細                      │
├─────────────────────────────────────┤
│ ⏰ 検知時刻: 2025-06-09 14:30:15    │
│ 💰 検知価格: $25.50                │
│ 🎪 推奨レバレッジ: 15.2x            │
│ 🎯 信頼度: 82.1%                   │
│ 📊 戦略: Conservative_ML            │
│                                    │
│ 📈 実際の結果:                      │
│ ├── 1時間後: +5.1% ✅               │
│ ├── 3時間後: +15.3% 🏆              │
│ ├── 1日後: -9.0% ❌                │
│ └── 最終評価: 成功 (短期利益確保)     │
└─────────────────────────────────────┘
```

### 5. **📊 統計・レポート機能**
```
📊 全体パフォーマンス（過去3ヶ月）
┌─────────────────────────────────────┐
│ 🎯 総アラート数: 245件               │
│ ✅ 成功率: 68.2%                   │
│ 📈 平均リターン: +8.7%              │
│ 🏆 最高リターン: +45.8% (PEPE)      │
│ 📉 最大損失: -18.3% (WIF)           │
│                                    │
│ 🏅 戦略別成功率:                    │
│ ├── Conservative_ML: 73% ✅          │
│ ├── Aggressive_Traditional: 61% ⚡   │
│ └── Full_ML: 58% 📊                │
│                                    │
│ 🪙 銘柄別成功率:                    │
│ ├── HYPE: 75% (48件)               │
│ ├── SOL: 71% (67件)                │
│ └── PEPE: 62% (39件)               │
└─────────────────────────────────────┘
```

## 📋 実装タスク一覧

### Phase 1: データベース基盤
- [ ] **アラート履歴データベース設計・実装**
  - SQLiteデータベーススキーマ設計
  - アラート情報テーブル作成
  - 価格追跡テーブル作成

### Phase 2: 価格追跡システム
- [ ] **価格追跡システム実装（アラート後の価格変動記録）**
  - 定期的な価格取得機能
  - アラート後の価格変動計算
  - パフォーマンス評価ロジック

### Phase 3: チャート表示機能
- [ ] **チャート表示ページ作成（Plotly.js統合）**
  - 新しいWebページ追加
  - Plotly.jsによるチャート描画
  - レスポンシブデザイン対応

### Phase 4: アラート可視化
- [ ] **アラートポイント・マーカー表示機能**
  - チャート上のアラートマーカー
  - アラート詳細ポップアップ
  - 成功/失敗の色分け表示

### Phase 5: 分析機能
- [ ] **パフォーマンス分析API実装**
  - 成功率計算API
  - リターン統計API
  - 戦略別分析API

### Phase 6: フィルタリング
- [ ] **トークン選択・期間フィルタリング機能**
  - トークン選択ドロップダウン
  - 期間範囲選択
  - 戦略別フィルタ

### Phase 7: 統計表示
- [ ] **成功率・統計情報表示**
  - 統計ダッシュボード
  - 戦略別パフォーマンス
  - 銘柄別成功率

### Phase 8: レポート機能
- [ ] **履歴分析レポート機能**
  - PDF/CSV エクスポート
  - 詳細分析レポート
  - パフォーマンス推移グラフ

## 🗄️ データベース設計

### テーブル設計

#### 1. alerts テーブル
```sql
CREATE TABLE alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    alert_id VARCHAR(255) UNIQUE,
    symbol VARCHAR(10),
    alert_type VARCHAR(50),
    priority VARCHAR(20),
    timestamp DATETIME,
    leverage REAL,
    confidence REAL,
    strategy VARCHAR(50),
    timeframe VARCHAR(10),
    entry_price REAL,
    target_price REAL,
    stop_loss REAL,
    metadata TEXT -- JSON形式
);
```

#### 2. price_tracking テーブル
```sql
CREATE TABLE price_tracking (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    alert_id VARCHAR(255),
    symbol VARCHAR(10),
    timestamp DATETIME,
    price REAL,
    time_elapsed_hours INTEGER, -- アラートからの経過時間
    percentage_change REAL, -- アラート時からの変動率
    FOREIGN KEY (alert_id) REFERENCES alerts(alert_id)
);
```

#### 3. performance_summary テーブル
```sql
CREATE TABLE performance_summary (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    alert_id VARCHAR(255),
    symbol VARCHAR(10),
    is_success BOOLEAN, -- 成功/失敗判定
    max_gain REAL, -- 最大利益率
    max_loss REAL, -- 最大損失率
    final_return_24h REAL, -- 24時間後リターン
    final_return_72h REAL, -- 72時間後リターン
    evaluation_note TEXT, -- 評価コメント
    FOREIGN KEY (alert_id) REFERENCES alerts(alert_id)
);
```

## 🛠️ 技術スタック

### バックエンド
- **データベース**: SQLite（軽量、ポータブル）
- **ORM**: SQLAlchemy（Pythonデータベース操作）
- **API**: Flask RESTful API
- **価格取得**: 既存のデータフェッチャーを活用

### フロントエンド
- **チャート**: Plotly.js（インタラクティブチャート）
- **UI**: Bootstrap 5 + カスタムCSS
- **JavaScript**: ES6+ 非同期処理
- **WebSocket**: リアルタイム更新

### データフロー
```
1. アラート検知 → データベース保存
2. 定期価格取得 → 価格変動記録
3. パフォーマンス計算 → 統計更新
4. Webページ表示 → チャート描画
```

## 🚀 実装の流れ

### Step 1: データベース基盤構築（30分）
- SQLiteデータベース作成
- テーブル設計とマイグレーション
- データベース接続クラス実装

### Step 2: 価格追跡システム（45分）
- 価格取得スケジューラー
- アラート後価格記録ロジック
- パフォーマンス評価計算

### Step 3: チャート表示ページ（60分）
- 新しいWebページ作成
- Plotly.js統合
- 基本チャート表示

### Step 4: アラート可視化（45分）
- チャート上のマーカー表示
- アラート詳細ポップアップ
- インタラクティブ機能

### Step 5: 分析・統計機能（30分）
- パフォーマンス分析API
- 統計計算ロジック
- レポート生成

**合計推定時間: 約3.5時間**

## 📊 期待される効果

### 1. **アラート精度の可視化**
- どの戦略が最も効果的かを定量評価
- 信頼度と実際の成功率の相関分析
- 時間足別の効果測定

### 2. **投資判断の改善**
- 過去のパフォーマンスに基づく戦略選択
- リスク管理の最適化
- エントリータイミングの精度向上

### 3. **システムの継続改善**
- アラート精度の追跡と改善
- 機械学習モデルの性能評価
- 新しい戦略の効果測定

これで、どのアラートが実際に利益につながったかを後から検証できるようになります！