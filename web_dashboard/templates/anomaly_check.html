<!DOCTYPE html>
<html>
<head>
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç•°å¸¸ãƒã‚§ãƒƒã‚¯ - {{ symbol if symbol else '' }}</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .metric {
            display: inline-block;
            margin: 10px 20px 10px 0;
        }
        .metric-label {
            font-weight: bold;
            color: #666;
        }
        .metric-value {
            font-size: 1.2em;
            color: #333;
        }
        .anomaly-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-left: 4px solid #dc3545;
        }
        .normal-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-left: 4px solid #28a745;
        }
        .back-link {
            display: inline-block;
            margin: 20px 0;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .back-link:hover {
            background: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .sample-trades {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="page-title">ğŸ” ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç•°å¸¸ãƒã‚§ãƒƒã‚¯</h1>
        
        <a href="/symbols" class="back-link">â† éŠ˜æŸ„ä¸€è¦§ã«æˆ»ã‚‹</a>
        
        <div id="loading" class="alert alert-info">
            <strong>èª­ã¿è¾¼ã¿ä¸­...</strong> ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™
        </div>
        
        <div id="error" class="alert alert-danger" style="display: none;">
            <strong>ã‚¨ãƒ©ãƒ¼:</strong> <span id="error-message"></span>
        </div>
        
        <div id="content" style="display: none;"></div>
        
        <a href="/symbols" class="back-link">â† éŠ˜æŸ„ä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>

    <script>
        // Get symbol from URL path
        const pathParts = window.location.pathname.split('/');
        const symbol = pathParts[pathParts.length - 1];
        
        // Update page title
        document.getElementById('page-title').textContent = `ğŸ” ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç•°å¸¸ãƒã‚§ãƒƒã‚¯: ${symbol}`;
        
        // Fetch anomaly data
        fetch(`/api/anomaly-check/${symbol}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                if (data.error) {
                    document.getElementById('error-message').textContent = data.error;
                    document.getElementById('error').style.display = 'block';
                } else {
                    renderAnomalyData(data);
                    document.getElementById('content').style.display = 'block';
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            });
        
        function renderAnomalyData(data) {
            const content = document.getElementById('content');
            
            const html = `
                <div class="section">
                    <h2>ğŸ“Š åŸºæœ¬çµ±è¨ˆ</h2>
                    <div class="metric">
                        <span class="metric-label">ç·å–å¼•æ•°:</span>
                        <span class="metric-value">${data.basic_stats.total_trades}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">å‹ç‡:</span>
                        <span class="metric-value">${(data.basic_stats.win_rate * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ç·ãƒªã‚¿ãƒ¼ãƒ³:</span>
                        <span class="metric-value">${data.basic_stats.total_return.toFixed(2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">å¹³å‡ãƒ¬ãƒãƒ¬ãƒƒã‚¸:</span>
                        <span class="metric-value">${data.basic_stats.avg_leverage.toFixed(1)}x</span>
                    </div>
                </div>
                
                <div class="section">
                    <h2>ğŸš¨ ç•°å¸¸æ¤œå‡ºçµæœ</h2>
                    
                    ${data.anomalies.length > 0 ? `
                        <div class="alert alert-danger">
                            <strong>âš ï¸ ${data.anomalies.length}ä»¶ã®ç•°å¸¸ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ</strong>
                        </div>
                        
                        ${data.anomalies.map(anomaly => `
                            <div class="anomaly-item">
                                <strong>${anomaly.type}:</strong> ${anomaly.description}
                                <br>
                                <small>è©³ç´°: ${anomaly.details}</small>
                            </div>
                        `).join('')}
                    ` : `
                        <div class="alert alert-success">
                            <strong>âœ… ç•°å¸¸ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</strong>
                        </div>
                    `}
                </div>
                
                <div class="section">
                    <h2>ğŸ“ˆ è©³ç´°åˆ†æ</h2>
                    
                    <h3>ãƒ¬ãƒãƒ¬ãƒƒã‚¸åˆ†æ</h3>
                    <div class="metric">
                        <span class="metric-label">ãƒ¦ãƒ‹ãƒ¼ã‚¯å€¤æ•°:</span>
                        <span class="metric-value">${data.leverage_stats.unique_count}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æ¨™æº–åå·®:</span>
                        <span class="metric-value">${data.leverage_stats.std.toFixed(4)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æœ€å°å€¤:</span>
                        <span class="metric-value">${data.leverage_stats.min.toFixed(2)}x</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æœ€å¤§å€¤:</span>
                        <span class="metric-value">${data.leverage_stats.max.toFixed(2)}x</span>
                    </div>
                    
                    <h3>ä¾¡æ ¼åˆ†æ</h3>
                    <div class="metric">
                        <span class="metric-label">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼ã®å¤šæ§˜æ€§:</span>
                        <span class="metric-value">${data.entry_price_stats.unique_count}/${data.entry_price_stats.total} (${(data.entry_price_stats.diversity_ratio * 100).toFixed(1)}%)</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ä¾¡æ ¼ç¯„å›²:</span>
                        <span class="metric-value">${data.entry_price_stats.min.toFixed(2)} - ${data.entry_price_stats.max.toFixed(2)}</span>
                    </div>
                    
                    <h3>PnLåˆ†æ</h3>
                    <div class="metric">
                        <span class="metric-label">å¹³å‡PnL:</span>
                        <span class="metric-value">${(data.pnl_stats.mean * 100).toFixed(2)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æœ€å¤§åˆ©ç›Š:</span>
                        <span class="metric-value">${(data.pnl_stats.max * 100).toFixed(2)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æœ€å¤§æå¤±:</span>
                        <span class="metric-value">${(data.pnl_stats.min * 100).toFixed(2)}%</span>
                    </div>
                </div>
                
                ${data.sample_trades.length > 0 ? `
                <div class="section">
                    <h2>ğŸ“‹ å…¨ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ (${data.sample_trades.length}ä»¶)</h2>
                    <div class="sample-trades">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ™‚åˆ»</th>
                                    <th>ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼</th>
                                    <th>ã‚¨ã‚°ã‚¸ãƒƒãƒˆä¾¡æ ¼</th>
                                    <th>ãƒ¬ãƒãƒ¬ãƒƒã‚¸</th>
                                    <th>PnL</th>
                                    <th>å‹æ•—</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.sample_trades.map((trade, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${trade.entry_time}</td>
                                        <td>${trade.entry_price.toFixed(2)}</td>
                                        <td>${trade.exit_price.toFixed(2)}</td>
                                        <td>${trade.leverage.toFixed(1)}x</td>
                                        <td>${(trade.pnl_pct * 100).toFixed(2)}%</td>
                                        <td>
                                            ${trade.is_success ? 
                                                '<span style="color: green;">âœ…</span>' : 
                                                '<span style="color: red;">âŒ</span>'
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
                
                <div class="section">
                    <h2>âœ… æ­£å¸¸ãƒã‚§ãƒƒã‚¯é …ç›®</h2>
                    ${data.normal_checks.map(check => `
                        <div class="normal-item">
                            <strong>${check.type}:</strong> ${check.description}
                        </div>
                    `).join('')}
                </div>
            `;
            
            content.innerHTML = html;
        }
    </script>
</body>
</html>