<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拡張銘柄管理 - Long Trader</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
    <style>
        /* Enhanced symbol management styles */
        .symbol-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .symbol-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #0d6efd;
        }
        
        .symbol-status-badge {
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
        }
        
        .form-check-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 10px;
        }
        
        .custom-strategy-item {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .custom-strategy-item:hover {
            background-color: #f8f9fa;
        }
        
        .custom-strategy-item.selected {
            background-color: #e7f3ff;
            border-color: #0d6efd;
        }
        
        .strategy-params {
            font-size: 0.875rem;
            color: #6c757d;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 5px;
            margin-top: 5px;
        }
    </style>
</head>

<body class="bg-light">
    <div class="dashboard-container">
        <!-- Header -->
        <nav class="navbar navbar-dark bg-dark">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">
                    <i class="fas fa-cogs"></i> 拡張戦略分析銘柄管理
                </span>
                <div class="d-flex align-items-center">
                    <!-- Exchange Switcher -->
                    <div class="dropdown me-3">
                        <button class="btn btn-outline-warning btn-sm dropdown-toggle" type="button" id="exchangeDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-exchange-alt"></i> <span id="current-exchange">Hyperliquid</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="switchExchange('hyperliquid')">
                                <i class="fas fa-fire text-warning"></i> Hyperliquid
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="switchExchange('gateio')">
                                <i class="fas fa-globe text-info"></i> Gate.io
                            </a></li>
                        </ul>
                    </div>
                    
                    <a href="/" class="btn btn-outline-light btn-sm me-2">
                        <i class="fas fa-arrow-left"></i> ダッシュボード
                    </a>
                    <a href="/symbols" class="btn btn-outline-info btn-sm me-2">
                        <i class="fas fa-coins"></i> 銘柄管理
                    </a>
                    <a href="/symbols-new" class="btn btn-outline-success btn-sm me-2">
                        <i class="fas fa-plus-circle"></i> 新銘柄追加
                    </a>
                    <span class="btn btn-secondary btn-sm me-2 disabled">
                        <i class="fas fa-cogs"></i> 拡張管理
                    </span>
                    <a href="/analysis" class="btn btn-outline-primary btn-sm me-2">
                        <i class="fas fa-chart-line"></i> 履歴分析
                    </a>
                    <a href="/strategy-results" class="btn btn-outline-info btn-sm me-2">
                        <i class="fas fa-trophy"></i> 戦略結果
                    </a>
                    <a href="/settings" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-cog"></i> 設定
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid mt-4">
            <div class="row">
                <div class="col-12">
                    <!-- Page Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-cogs text-primary"></i> 拡張戦略カスタマイズ銘柄管理</h2>
                        <div class="badge bg-info fs-6">戦略選択対応</div>
                    </div>
                    
                    <!-- Alert Area -->
                    <div id="alertArea"></div>
                    
                    <!-- Enhanced Add Symbol Form -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-plus-circle"></i> 銘柄追加 (戦略選択対応)</h5>
                        </div>
                        <div class="card-body">
                            <form id="enhancedAddSymbolForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">銘柄シンボル <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="enhancedSymbolInput" 
                                               placeholder="例: HYPE, SOL, ETH" required>
                                        <small class="text-muted">大文字小文字は自動変換されます</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">実行モード</label>
                                        <select class="form-select" id="executionMode" onchange="toggleExecutionOptions()">
                                            <option value="default">デフォルト実行 (全戦略・全時間足)</option>
                                            <option value="selective">選択実行 (戦略・時間足を指定)</option>
                                            <option value="custom">カスタム戦略実行</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- 選択実行オプション -->
                                <div id="selectiveOptions" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">戦略選択</label>
                                            <div class="form-check-container">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="strategy_Conservative_ML" value="Conservative_ML" checked>
                                                    <label class="form-check-label" for="strategy_Conservative_ML">Conservative ML</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="strategy_Aggressive_ML" value="Aggressive_ML" checked>
                                                    <label class="form-check-label" for="strategy_Aggressive_ML">Aggressive ML</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="strategy_Full_ML" value="Full_ML" checked>
                                                    <label class="form-check-label" for="strategy_Full_ML">Full ML</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="strategy_Balanced" value="Balanced">
                                                    <label class="form-check-label" for="strategy_Balanced">Balanced</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="strategy_Traditional" value="Traditional">
                                                    <label class="form-check-label" for="strategy_Traditional">Traditional</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">時間足選択</label>
                                            <div class="form-check-container">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="timeframe_1m" value="1m">
                                                    <label class="form-check-label" for="timeframe_1m">1分</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="timeframe_3m" value="3m">
                                                    <label class="form-check-label" for="timeframe_3m">3分</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="timeframe_5m" value="5m">
                                                    <label class="form-check-label" for="timeframe_5m">5分</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="timeframe_15m" value="15m" checked>
                                                    <label class="form-check-label" for="timeframe_15m">15分</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="timeframe_30m" value="30m" checked>
                                                    <label class="form-check-label" for="timeframe_30m">30分</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="timeframe_1h" value="1h" checked>
                                                    <label class="form-check-label" for="timeframe_1h">1時間</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> 
                                        選択した戦略と時間足の組み合わせのみ実行されます。
                                        処理時間を大幅に短縮できます。
                                    </div>
                                </div>
                                
                                <!-- カスタム戦略オプション -->
                                <div id="customOptions" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">カスタム戦略選択</label>
                                        <div id="customStrategyList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                            <div class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">読み込み中...</span>
                                                </div>
                                                カスタム戦略を読み込み中...
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle"></i> 
                                        選択したカスタム戦略のパラメータ設定で実行されます。
                                    </div>
                                </div>
                                
                                <!-- 実行予測 -->
                                <div id="executionEstimate" class="alert alert-secondary" style="display: none;">
                                    <strong>実行予測:</strong>
                                    <span id="estimateText">-</span>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-primary" onclick="validateSymbol()">
                                        <i class="bi bi-search"></i> 事前検証
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-play-circle"></i> バックテスト開始
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Manual Reset Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-tools"></i> 実行管理</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-list"></i> 実行中の銘柄</h6>
                                    <p class="text-muted small">現在バックテスト実行中の銘柄一覧</p>
                                    <div id="running-symbols-list" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                        <div class="text-center text-muted">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">読み込み中...</span>
                                            </div>
                                            実行中の銘柄を読み込み中...
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-stop-circle"></i> 手動リセット</h6>
                                    <p class="text-muted small">選択した実行中の銘柄を手動で停止します</p>
                                    <select class="form-select mb-2" id="select-running-symbol">
                                        <option value="">実行中の銘柄を選択...</option>
                                    </select>
                                    <button class="btn btn-danger" id="btn-manual-reset" disabled>
                                        <i class="fas fa-times-circle"></i> 選択した銘柄を停止
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Feature Description -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                                    <h5>選択実行</h5>
                                    <p class="text-muted">戦略と時間足を組み合わせて効率的な分析が可能</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-cogs fa-3x text-success mb-3"></i>
                                    <h5>カスタム戦略</h5>
                                    <p class="text-muted">独自パラメータで最適化されたカスタム戦略実行</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                                    <h5>効率化</h5>
                                    <p class="text-muted">最大90%の処理時間短縮を実現</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    
    <script>
        let customStrategies = [];
        let selectedCustomStrategies = [];

        // 実行モード切り替え
        function toggleExecutionOptions() {
            const mode = document.getElementById('executionMode').value;
            const selectiveOptions = document.getElementById('selectiveOptions');
            const customOptions = document.getElementById('customOptions');
            const estimateDiv = document.getElementById('executionEstimate');
            
            selectiveOptions.style.display = mode === 'selective' ? 'block' : 'none';
            customOptions.style.display = mode === 'custom' ? 'block' : 'none';
            
            if (mode === 'custom' && customStrategies.length === 0) {
                loadCustomStrategies();
            }
            
            updateExecutionEstimate();
            estimateDiv.style.display = mode !== 'default' ? 'block' : 'none';
        }

        // カスタム戦略読み込み
        async function loadCustomStrategies() {
            try {
                const response = await axios.get('/api/strategy-configs?is_active=true');
                if (response.data.success) {
                    customStrategies = response.data.data;
                    renderCustomStrategies();
                }
            } catch (error) {
                console.error('カスタム戦略読み込みエラー:', error);
                document.getElementById('customStrategyList').innerHTML = 
                    '<div class="text-danger">カスタム戦略の読み込みに失敗しました</div>';
            }
        }

        // カスタム戦略一覧描画
        function renderCustomStrategies() {
            const container = document.getElementById('customStrategyList');
            
            if (customStrategies.length === 0) {
                container.innerHTML = '<div class="text-muted">利用可能なカスタム戦略がありません</div>';
                return;
            }
            
            container.innerHTML = customStrategies.map(strategy => `
                <div class="custom-strategy-item" onclick="toggleCustomStrategy(${strategy.id})">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="custom_${strategy.id}" onchange="toggleCustomStrategy(${strategy.id})">
                        <label class="form-check-label" for="custom_${strategy.id}">
                            <strong>${strategy.name}</strong>
                            <span class="badge bg-secondary ms-2">${strategy.base_strategy}</span>
                            <span class="badge bg-info ms-1">${strategy.timeframe}</span>
                        </label>
                    </div>
                    <div class="strategy-params">
                        ${Object.entries(strategy.parameters).map(([key, value]) => 
                            `<span><strong>${formatParameterName(key)}:</strong> ${value}</span>`
                        ).join('')}
                    </div>
                    ${strategy.description ? `<small class="text-muted">${strategy.description}</small>` : ''}
                </div>
            `).join('');
        }

        // カスタム戦略選択切り替え
        function toggleCustomStrategy(strategyId) {
            const checkbox = document.getElementById(`custom_${strategyId}`);
            const strategyItem = checkbox.closest('.custom-strategy-item');
            
            if (checkbox.checked) {
                if (!selectedCustomStrategies.includes(strategyId)) {
                    selectedCustomStrategies.push(strategyId);
                    strategyItem.classList.add('selected');
                }
            } else {
                const index = selectedCustomStrategies.indexOf(strategyId);
                if (index > -1) {
                    selectedCustomStrategies.splice(index, 1);
                    strategyItem.classList.remove('selected');
                }
            }
            
            updateExecutionEstimate();
        }

        // パラメータ名フォーマット
        function formatParameterName(key) {
            const nameMap = {
                'risk_multiplier': 'リスク乗数',
                'leverage_cap': '最大レバレッジ',
                'min_risk_reward': '最小RR比',
                'confidence_boost': '信頼度調整',
                'stop_loss_percent': 'SL%',
                'take_profit_percent': 'TP%'
            };
            return nameMap[key] || key;
        }

        // 実行予測更新
        function updateExecutionEstimate() {
            const mode = document.getElementById('executionMode').value;
            const estimateText = document.getElementById('estimateText');
            
            let count = 0;
            let efficiency = 0;
            
            if (mode === 'default') {
                count = 3 * 6; // 3戦略 × 6時間足
                efficiency = 0;
            } else if (mode === 'selective') {
                const selectedStrategies = Array.from(document.querySelectorAll('input[id^="strategy_"]:checked')).length;
                const selectedTimeframes = Array.from(document.querySelectorAll('input[id^="timeframe_"]:checked')).length;
                count = selectedStrategies * selectedTimeframes;
                efficiency = Math.round((1 - count / 18) * 100);
            } else if (mode === 'custom') {
                count = selectedCustomStrategies.length;
                efficiency = Math.round((1 - count / 18) * 100);
            }
            
            let text = `約${count}パターンの分析を実行`;
            if (efficiency > 0) {
                text += ` (${efficiency}%効率化)`;
            }
            
            estimateText.textContent = text;
        }

        // 手動リセット機能
        async function loadRunningSymbols() {
            try {
                const response = await axios.get('/api/symbols/status');
                if (response.data && response.data.running) {
                    updateRunningSymbolsList(response.data.running);
                    updateRunningSymbolsSelect(response.data.running);
                }
            } catch (error) {
                console.error('実行中銘柄の読み込みエラー:', error);
                document.getElementById('running-symbols-list').innerHTML = 
                    '<div class="text-danger">実行中銘柄の読み込みに失敗しました</div>';
            }
        }
        
        function updateRunningSymbolsList(runningSymbols) {
            const container = document.getElementById('running-symbols-list');
            
            if (runningSymbols.length === 0) {
                container.innerHTML = '<div class="text-muted">実行中の銘柄はありません</div>';
                return;
            }
            
            container.innerHTML = runningSymbols.map(symbol => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <div>
                        <strong>${symbol.symbol}</strong>
                        <small class="text-muted d-block">${symbol.current_operation || '分析中'}</small>
                    </div>
                    <div class="text-end">
                        <div class="progress" style="width: 100px; height: 8px;">
                            <div class="progress-bar" style="width: ${symbol.progress_percentage || 0}%"></div>
                        </div>
                        <small class="text-muted">${symbol.progress_percentage || 0}%</small>
                    </div>
                </div>
            `).join('');
        }
        
        function updateRunningSymbolsSelect(runningSymbols) {
            const select = document.getElementById('select-running-symbol');
            const resetBtn = document.getElementById('btn-manual-reset');
            
            // セレクトボックスをクリア
            select.innerHTML = '<option value="">実行中の銘柄を選択...</option>';
            
            // 実行中の銘柄を追加
            runningSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol.execution_id;
                option.textContent = `${symbol.symbol} (${symbol.progress_percentage || 0}% - ${symbol.current_operation || '分析中'})`;
                select.appendChild(option);
            });
            
            // リセットボタンの状態更新
            resetBtn.disabled = true;
        }
        
        async function manualResetExecution(executionId) {
            const select = document.getElementById('select-running-symbol');
            const selectedOption = select.options[select.selectedIndex];
            const symbolName = selectedOption.textContent.split(' (')[0];
            
            if (!confirm(`${symbolName}の実行を停止します。\n続行しますか？`)) {
                return;
            }
            
            try {
                const response = await axios.post('/api/admin/reset-execution', {
                    execution_id: executionId
                });
                
                if (response.data.success) {
                    showAlert(`✅ ${symbolName}の実行を停止しました`, 'success');
                    // セレクトボックスをリセット
                    select.value = '';
                    document.getElementById('btn-manual-reset').disabled = true;
                    // データを更新
                    await loadRunningSymbols();
                } else {
                    showAlert(`エラー: ${response.data.error || '不明なエラー'}`, 'danger');
                }
            } catch (error) {
                console.error('手動リセットエラー:', error);
                const errorMsg = error.response?.data?.error || 'ネットワークエラー';
                showAlert(`エラー: ${errorMsg}`, 'danger');
            }
        }

        // イベントリスナー追加
        document.addEventListener('DOMContentLoaded', function() {
            // 戦略・時間足選択の変更監視
            document.querySelectorAll('input[id^="strategy_"], input[id^="timeframe_"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateExecutionEstimate);
            });
            
            // 手動リセット機能のイベントリスナー
            const selectRunning = document.getElementById('select-running-symbol');
            const btnReset = document.getElementById('btn-manual-reset');
            
            selectRunning.addEventListener('change', (e) => {
                btnReset.disabled = !e.target.value;
            });
            
            btnReset.addEventListener('click', () => {
                const executionId = selectRunning.value;
                if (executionId) {
                    manualResetExecution(executionId);
                }
            });
            
            // 実行中銘柄の初期読み込み
            loadRunningSymbols();
            
            // 20秒毎に実行中銘柄を更新
            setInterval(loadRunningSymbols, 20000);
            
            // 現在の取引所設定を読み込み
            loadCurrentExchange();
        });

        // 拡張フォーム送信
        document.getElementById('enhancedAddSymbolForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('enhancedSymbolInput').value.trim().toUpperCase();
            const mode = document.getElementById('executionMode').value;
            
            if (!symbol) {
                showAlert('銘柄シンボルを入力してください', 'warning');
                return;
            }
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 実行中...';
            submitButton.disabled = true;
            
            try {
                const payload = { symbol };
                
                if (mode === 'selective') {
                    // 選択された戦略・時間足を取得
                    const selectedStrategies = Array.from(document.querySelectorAll('input[id^="strategy_"]:checked'))
                        .map(cb => cb.value);
                    const selectedTimeframes = Array.from(document.querySelectorAll('input[id^="timeframe_"]:checked'))
                        .map(cb => cb.value);
                    
                    if (selectedStrategies.length === 0 || selectedTimeframes.length === 0) {
                        showAlert('戦略と時間足を少なくとも1つずつ選択してください', 'warning');
                        return;
                    }
                    
                    payload.selected_strategies = selectedStrategies;
                    payload.selected_timeframes = selectedTimeframes;
                    
                } else if (mode === 'custom') {
                    // 選択されたカスタム戦略を取得
                    if (selectedCustomStrategies.length === 0) {
                        showAlert('カスタム戦略を少なくとも1つ選択してください', 'warning');
                        return;
                    }
                    
                    payload.strategy_configs = customStrategies.filter(s => 
                        selectedCustomStrategies.includes(s.id)
                    );
                }
                
                const response = await axios.post('/api/symbol/add', payload, {
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.data.status === 'started') {
                    showAlert(`${symbol}の分析を開始しました (実行ID: ${response.data.execution_id})`, 'success');
                    
                    // フォームリセット
                    document.getElementById('enhancedSymbolInput').value = '';
                    document.getElementById('executionMode').value = 'default';
                    toggleExecutionOptions();
                    
                    // ページ更新（実行ログなどに反映）
                    setTimeout(() => {
                        if (typeof loadExecutions === 'function') loadExecutions();
                        if (typeof loadRecentAnalyses === 'function') loadRecentAnalyses();
                    }, 1000);
                    
                } else {
                    showAlert('予期しないレスポンスです', 'warning');
                }
                
            } catch (error) {
                console.error('銘柄追加エラー:', error);
                const errorMsg = error.response?.data?.error || '銘柄追加に失敗しました';
                showAlert(errorMsg, 'danger');
            } finally {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        // 事前検証
        async function validateSymbol() {
            const symbol = document.getElementById('enhancedSymbolInput').value.trim().toUpperCase();
            
            if (!symbol) {
                showAlert('銘柄シンボルを入力してください', 'warning');
                return;
            }
            
            try {
                // Early Fail検証をシミュレート
                showAlert(`${symbol}の事前検証を開始中...`, 'info');
                
                // 実際の検証ロジックはここに実装
                setTimeout(() => {
                    showAlert(`${symbol}は有効な銘柄です`, 'success');
                }, 1500);
                
            } catch (error) {
                console.error('検証エラー:', error);
                showAlert('事前検証に失敗しました', 'danger');
            }
        }
    </script>
</body>
</html>